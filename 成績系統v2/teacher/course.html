<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課程管理</title>
    <!-- Bootstrap 5 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <style>
      body {
        background-color: #eaf6ff;
      }
      .card {
        border-radius: 12px;
      }
      .btn-cool {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
        transition: 0.3s;
      }
      .btn-cool:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
      }
      .back-button {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #0d6efd;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
      }
      .back-button:hover {
        background-color: #0b5ed7;
      }
    </style>
</head>
<body>
    <a href="main.html" class="back-button">返回主選單</a>
    <div class="container py-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="mb-4">建立新課程</h2>
                <form id="courseForm">
                    <div class="mb-3">
                        <label for="c_no" class="form-label">課程代碼</label>
                        <input type="text" id="c_no" name="c_no" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">課程名稱</label>
                        <input type="text" id="title" name="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="credits" class="form-label">學分數</label>
                        <input type="number" id="credits" name="credits" class="form-control" required min="0" max="6">
                    </div>
                    <div class="mb-3">
                        <label for="semester" class="form-label">學期</label>
                        <input type="text" id="semester" name="semester" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="day_of_week" class="form-label">上課星期</label>
                        <select id="day_of_week" name="day_of_week" class="form-select" required>
                            <option value="1">星期一</option>
                            <option value="2">星期二</option>
                            <option value="3">星期三</option>
                            <option value="4">星期四</option>
                            <option value="5">星期五</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="start_time" class="form-label">開始時間</label>
                        <input type="time" id="start_time" name="start_time" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="end_time" class="form-label">結束時間</label>
                        <input type="time" id="end_time" name="end_time" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-cool w-100">建立課程</button>
                </form>
            </div>
        </div>

        <hr>

        <h2 class="mt-5">所有課程</h2>
        <div id="all-courses" class="mt-3">
            <!-- 所有課程列表 -->
        </div>

        <hr>

        <h2 class="mt-5">我的課程</h2>
        <div id="my-courses" class="mt-3">
            <!-- 我的課程列表 -->
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    ></script>
    <script>
        window.onload = function() {
            fetch('course.php')
                .then(response => response.json())
                .then(data => {
                    displayAllCourses(data.allCourses);
                    displayMyCourses(data.myCourses);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function displayAllCourses(courses) {
            const table = document.createElement('table');
            table.className = 'table table-bordered';
            table.innerHTML = `
                <thead class="table-light">
                    <tr>
                        <th>班級</th>
                        <th>課程名稱</th>
                        <th>學分數</th>
                        <th>學期</th>
                        <th>上課時間</th>
                        <th>授課教師</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;

            const tbody = table.querySelector('tbody');
            courses.forEach(course => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${course.c_no}</td>
                    <td>${course.title}</td>
                    <td>${course.credits}</td>
                    <td>${course.semester}</td>
                    <td>${course.day_of_week} ${course.start_time}-${course.end_time}</td>
                    <td>${course.instructor_names || '未指定'}</td>
                    <td>
                        ${!course.is_teaching ? `
                            <button class="btn btn-cool btn-sm" onclick="joinCourse('${course.c_no}')">加入授課</button>
                        ` : '已加入'}
                    </td>
                `;
            });

            document.getElementById('all-courses').innerHTML = '';
            document.getElementById('all-courses').appendChild(table);
        }

        function joinCourse(c_no) {
            if (confirm('確定要加入此課程的授課教師？')) {
                fetch('join_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `c_no=${c_no}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('加入成功！');
                        window.location.reload();
                    } else {
                        alert(data.message || '加入失敗！');
                    }
                });
            }
        }

        document.getElementById('courseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const isUpdate = document.getElementById('c_no').readOnly;

            fetch('course.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(isUpdate ? '課程更新成功！' : '課程建立成功！');
                    window.location.reload();
                } else {
                    alert(data.message || '操作失敗！');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('發生錯誤：' + error.message);
            });
        });

        function deleteCourse(c_no) {
            if (confirm('確定要刪除此課程嗎？')) {
                fetch('delete_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `c_no=${c_no}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('課程刪除成功！');
                        window.location.reload();
                    } else {
                        alert(data.message || '刪除失敗！');
                    }
                });
            }
        }

        function displayMyCourses(courses) {
            const table = document.createElement('table');
            table.className = 'table table-bordered';
            table.innerHTML = `
                <thead class="table-light">
                    <tr>
                        <th>班級</th>
                        <th>課程名稱</th>
                        <th>學分數</th>
                        <th>學期</th>
                        <th>上課時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;

            const tbody = table.querySelector('tbody');
            courses.forEach(course => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${course.c_no}</td>
                    <td>${course.title}</td>
                    <td>${course.credits}</td>
                    <td>${course.semester}</td>
                    <td>${course.day_of_week} ${course.start_time}-${course.end_time}</td>
                    <td>
                        <button class="btn btn-cool btn-sm" onclick="editCourse('${course.c_no}')">修改</button>
                        ${course.teacher_count > 1 
                            ? `<button class="btn btn-danger btn-sm" onclick="leaveCourse('${course.c_no}')">退出</button>`
                            : `<button class="btn btn-danger btn-sm" onclick="deleteCourse('${course.c_no}')">刪除</button>`
                        }
                    </td>
                `;
            });

            document.getElementById('my-courses').innerHTML = '';
            document.getElementById('my-courses').appendChild(table);
        }

        function editCourse(c_no) {
            fetch(`get_course.php?c_no=${c_no}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('c_no').value = data.c_no;
                    document.getElementById('title').value = data.title;
                    document.getElementById('credits').value = data.credits;
                    document.getElementById('semester').value = data.semester;
                    document.getElementById('day_of_week').value = data.day_of_week;
                    document.getElementById('start_time').value = data.start_time;
                    document.getElementById('end_time').value = data.end_time;
                    
                    document.querySelector('#courseForm button[type="submit"]').textContent = '更新課程';
                    document.getElementById('c_no').readOnly = true;
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'btn btn-secondary';
                    cancelBtn.style.marginLeft = '10px';
                    cancelBtn.textContent = '取消編輯';
                    cancelBtn.onclick = resetForm;
                    document.querySelector('#courseForm button[type="submit"]').after(cancelBtn);
                });
        }

        function resetForm() {
            document.getElementById('courseForm').reset();
            document.getElementById('c_no').readOnly = false;
            document.querySelector('#courseForm button[type="submit"]').textContent = '建立課程';
            const cancelBtn = document.querySelector('#courseForm button[type="button"]');
            if (cancelBtn) cancelBtn.remove();
        }

        function leaveCourse(c_no) {
            if (confirm('確定要退出此課程的授課？')) {
                fetch('leave_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `c_no=${c_no}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('退出成功！');
                        window.location.reload();
                    } else {
                        alert(data.message || '退出失敗！');
                    }
                });
            }
        }
    </script>
</body>
</html>
