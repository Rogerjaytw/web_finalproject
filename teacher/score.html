<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成績登入</title>
    <style>
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        .back-button:hover {
            background-color: #45a049;
        }
        .score-input {
            width: 60px;
            padding: 4px;
        }
        .save-btn {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .save-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="main.html" class="back-button">返回主選單</a>
        
        <h2>成績登入</h2>
        <div class="course-select">
            <label for="course">選擇課程：</label>
            <select id="course" onchange="loadStudents()">
                <option value="">請選擇課程</option>
            </select>
        </div>

        <div id="student-list">
            <!-- 學生列表將動態載入 -->
        </div>
    </div>

    <script>
        window.onload = function() {
            // 載入教師的課程
            fetch('score.php')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('course');
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.c_no;
                        option.textContent = `${course.c_no} - ${course.title}`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('載入課程失敗！');
                });
        }

        function loadStudents() {
            const c_no = document.getElementById('course').value;
            if (!c_no) {
                document.getElementById('student-list').innerHTML = '';
                return;
            }

            fetch(`score.php?c_no=${c_no}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data); // 添加調試信息
                    if (data.message) {
                        document.getElementById('student-list').innerHTML = 
                            `<h3 style="text-align: center; color: #666;">${data.message}</h3>`;
                    } else if (data.students) {
                        displayStudents(data.students);
                    } else {
                        console.error('Unexpected data format:', data);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('student-list').innerHTML = 
                        '<p style="color: red;">載入學生資料失敗</p>';
                });
        }

        function displayStudents(students) {
            if (!Array.isArray(students) || students.length === 0) {
                document.getElementById('student-list').innerHTML = 
                    '<h3 style="text-align: center; color: #666;">尚未有人選修</h3>';
                return;
            }

            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>學號</th>
                    <th>姓名</th>
                    <th>期中考</th>
                    <th>期末考</th>
                    <th>操作</th>
                </tr>
            `;

            students.forEach(student => {
                const row = table.insertRow();
                const hasScores = student.midterm !== null || student.final !== null;
                row.innerHTML = `
                    <td>${student.sid}</td>
                    <td>${student.name}</td>
                    <td>
                        <input type="number" class="score-input" 
                               value="${student.midterm || ''}" 
                               id="midterm_${student.sid}" 
                               min="0" max="100">
                    </td>
                    <td>
                        <input type="number" class="score-input" 
                               value="${student.final || ''}" 
                               id="final_${student.sid}" 
                               min="0" max="100">
                    </td>
                    <td>
                        <button class="save-btn" 
                                onclick="saveScores('${student.sid}')">
                            ${hasScores ? '修改成績' : '儲存成績'}
                        </button>
                    </td>
                `;
            });

            document.getElementById('student-list').innerHTML = '';
            document.getElementById('student-list').appendChild(table);
        }

        function saveScores(sid) {
            const c_no = document.getElementById('course').value;
            const midterm = document.getElementById(`midterm_${sid}`).value;
            const final = document.getElementById(`final_${sid}`).value;

            // 驗證成績
            if ((midterm && (midterm < 0 || midterm > 100)) || 
                (final && (final < 0 || final > 100))) {
                alert('成績必須在 0-100 之間！');
                return;
            }

            fetch('score.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sid: sid,
                    c_no: c_no,
                    midterm: midterm || null,
                    final: final || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('成績儲存成功！');
                    loadStudents(); // 重新載入學生列表
                } else {
                    alert(data.message || '成績儲存失敗！');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('儲存失敗，請稍後再試！');
            });
        }
    </script>
</body>
</html>
