<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課程管理</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        .back-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="main.html" class="back-button">返回主選單</a>
        
        <h2>建立新課程</h2>
        <form id="courseForm">
            <div class="form-group">
                <label for="c_no">課程代碼</label>
                <input type="text" id="c_no" name="c_no" required>
            </div>
            <div class="form-group">
                <label for="title">課程名稱</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="credits">學分數</label>
                <input type="number" id="credits" name="credits" required min="0" max="6">
            </div>
            <div class="form-group">
                <label for="semester">學期</label>
                <input type="text" id="semester" name="semester" required>
            </div>
            <div class="form-group">
                <label for="day_of_week">上課星期</label>
                <select id="day_of_week" name="day_of_week" required>
                    <option value="1">星期一</option>
                    <option value="2">星期二</option>
                    <option value="3">星期三</option>
                    <option value="4">星期四</option>
                    <option value="5">星期五</option>
                    <!-- 'Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'-->
                </select>
            </div>
            <div class="form-group">
                <label for="start_time">開始時間</label>
                <input type="time" id="start_time" name="start_time" required>
            </div>
            <div class="form-group">
                <label for="end_time">結束時間</label>
                <input type="time" id="end_time" name="end_time" required>
            </div>
            <button type="submit" class="btn">建立課程</button>
        </form>

        <hr>

        <h2>所有課程</h2>
        <div id="all-courses">
            <!-- 所有課程列表 -->
        </div>

        <hr>

        <h2>我的課程</h2>
        <div id="my-courses">
            <!-- 我的課程列表 -->
        </div>
    </div>

    <script>
        window.onload = function() {
            fetch('course.php')
                .then(response => response.json())
                .then(data => {
                    displayAllCourses(data.allCourses);
                    displayMyCourses(data.myCourses);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function displayAllCourses(courses) {
            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>班級</th>
                    <th>課程名稱</th>
                    <th>學分數</th>
                    <th>學期</th>
                    <th>上課時間</th>
                    <th>授課教師</th>
                    <th>操作</th>
                </tr>
            `;

            courses.forEach(course => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${course.c_no}</td>
                    <td>${course.title}</td>
                    <td>${course.credits}</td>
                    <td>${course.semester}</td>
                    <td>${course.day_of_week} ${course.start_time}-${course.end_time}</td>
                    <td>${course.instructor_names || '未指定'}</td>
                    <td>
                        ${!course.is_teaching ? `
                            <button onclick="joinCourse('${course.c_no}')">加入授課</button>
                        ` : '已加入'}
                    </td>
                `;
            });

            document.getElementById('all-courses').innerHTML = '';
            document.getElementById('all-courses').appendChild(table);
        }

        function joinCourse(c_no) {
            if (confirm('確定要加入此課程的授課教師？')) {
                fetch('join_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `c_no=${c_no}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('加入成功！');
                        window.location.reload();
                    } else {
                        alert(data.message || '加入失敗！');
                    }
                });
            }
        }

        // 表單提交
        document.getElementById('courseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // 檢查是否為更新操作
            const isUpdate = document.getElementById('c_no').readOnly;
            
            fetch('course.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(isUpdate ? '課程更新成功！' : '課程建立成功！');
                    window.location.reload();
                } else {
                    alert(data.message || '操作失敗！');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('發生錯誤：' + error.message);
            });
        });

        // 刪除課程
        function deleteCourse(c_no) {
            if (confirm('確定要刪除此課程嗎？')) {
                fetch('delete_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `c_no=${c_no}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('課程刪除成功！');
                        window.location.reload();
                    } else {
                        alert(data.message || '刪除失敗！');
                    }
                });
            }
        }

        function displayMyCourses(courses) {
            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>班級</th>
                    <th>課程名稱</th>
                    <th>學分數</th>
                    <th>學期</th>
                    <th>上課時間</th>
                    <th>操作</th>
                </tr>
            `;

            courses.forEach(course => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${course.c_no}</td>
                    <td>${course.title}</td>
                    <td>${course.credits}</td>
                    <td>${course.semester}</td>
                    <td>${course.day_of_week} ${course.start_time}-${course.end_time}</td>
                    <td>
                        <button onclick="editCourse('${course.c_no}')">修改</button>
                        ${course.teacher_count > 1 
                            ? `<button onclick="leaveCourse('${course.c_no}')">退出</button>`
                            : `<button onclick="deleteCourse('${course.c_no}')">刪除</button>`
                        }
                    </td>
                `;
            });

            document.getElementById('my-courses').innerHTML = '';
            document.getElementById('my-courses').appendChild(table);
        }

        function editCourse(c_no) {
            fetch(`get_course.php?c_no=${c_no}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('c_no').value = data.c_no;
                    document.getElementById('title').value = data.title;
                    document.getElementById('credits').value = data.credits;
                    document.getElementById('semester').value = data.semester;
                    document.getElementById('day_of_week').value = data.day_of_week;
                    document.getElementById('start_time').value = data.start_time;
                    document.getElementById('end_time').value = data.end_time;
                    
                    // 修改表單提交按鈕文字
                    document.querySelector('#courseForm button[type="submit"]').textContent = '更新課程';
                    document.getElementById('c_no').readOnly = true;
                    
                    // 添加取消編輯按鈕
                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'btn';
                    cancelBtn.style.marginLeft = '10px';
                    cancelBtn.textContent = '取消編輯';
                    cancelBtn.onclick = resetForm;
                    document.querySelector('#courseForm button[type="submit"]').after(cancelBtn);
                });
        }

        function resetForm() {
            document.getElementById('courseForm').reset();
            document.getElementById('c_no').readOnly = false;
            document.querySelector('#courseForm button[type="submit"]').textContent = '建立課程';
            const cancelBtn = document.querySelector('#courseForm button[type="button"]');
            if (cancelBtn) cancelBtn.remove();
        }

        function leaveCourse(c_no) {
            if (confirm('確定要退出此課程的授課？')) {
                fetch('leave_course.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `c_no=${c_no}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('退出成功！');
                        window.location.reload();
                    } else {
                        alert(data.message || '退出失敗！');
                    }
                });
            }
        }
    </script>
</body>
</html>
